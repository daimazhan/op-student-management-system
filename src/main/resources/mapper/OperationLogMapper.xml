<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.studentmanagement.mapper.OperationLogMapper">

    <resultMap id="BaseResultMap" type="com.example.studentmanagement.entity.OperationLog">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="username" property="username"/>
        <result column="operation_type" property="operationType"/>
        <result column="operation_module" property="operationModule"/>
        <result column="operation_content" property="operationContent"/>
        <result column="request_method" property="requestMethod"/>
        <result column="request_url" property="requestUrl"/>
        <result column="ip_address" property="ipAddress"/>
        <result column="status" property="status"/>
        <result column="error_message" property="errorMessage"/>
        <result column="operation_time" property="operationTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, user_id, username, operation_type, operation_module, operation_content,
        request_method, request_url, ip_address, status, error_message, operation_time
    </sql>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO operation_log (
            user_id, username, operation_type, operation_module, operation_content,
            request_method, request_url, ip_address, status, error_message, operation_time
        ) VALUES (
            #{userId}, #{username}, #{operationType}, #{operationModule}, #{operationContent},
            #{requestMethod}, #{requestUrl}, #{ipAddress}, #{status}, #{errorMessage}, #{operationTime}
        )
    </insert>

    <select id="findById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM operation_log
        WHERE id = #{id}
    </select>

    <select id="list" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM operation_log
        <where>
            <if test="query.username != null and query.username != ''">
                AND username LIKE CONCAT('%', #{query.username}, '%')
            </if>
            <if test="query.operationType != null and query.operationType != ''">
                AND operation_type = #{query.operationType}
            </if>
            <if test="query.operationModule != null and query.operationModule != ''">
                AND operation_module = #{query.operationModule}
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.startTime != null">
                AND operation_time >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND operation_time &lt;= #{query.endTime}
            </if>
        </where>
        ORDER BY operation_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="count" resultType="Long">
        SELECT COUNT(*)
        FROM operation_log
        <where>
            <if test="query.username != null and query.username != ''">
                AND username LIKE CONCAT('%', #{query.username}, '%')
            </if>
            <if test="query.operationType != null and query.operationType != ''">
                AND operation_type = #{query.operationType}
            </if>
            <if test="query.operationModule != null and query.operationModule != ''">
                AND operation_module = #{query.operationModule}
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.startTime != null">
                AND operation_time >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND operation_time &lt;= #{query.endTime}
            </if>
        </where>
    </select>

    <!-- 按操作类型统计 -->
    <select id="countByType" resultType="map">
        SELECT 
            operation_type as name,
            COUNT(*) as value
        FROM operation_log
        GROUP BY operation_type
        ORDER BY value DESC
    </select>

    <!-- 按操作模块统计 -->
    <select id="countByModule" resultType="map">
        SELECT 
            operation_module as name,
            COUNT(*) as value
        FROM operation_log
        WHERE operation_module IS NOT NULL
        GROUP BY operation_module
        ORDER BY value DESC
    </select>

    <!-- 按用户统计 -->
    <select id="countByUser" resultType="map">
        SELECT 
            username as name,
            COUNT(*) as value
        FROM operation_log
        WHERE username IS NOT NULL
        GROUP BY username
        ORDER BY value DESC
        LIMIT 10
    </select>

    <!-- 按日期统计（最近7天） -->
    <select id="countByDate" resultType="map">
        SELECT 
            DATE(operation_time) as name,
            COUNT(*) as value
        FROM operation_log
        WHERE operation_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
        GROUP BY DATE(operation_time)
        ORDER BY name ASC
    </select>

</mapper>

